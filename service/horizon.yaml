dsl_version: 0.1.0
service:
  name: horizon
  ports:
    - {{ horizon.port }}
  containers:
    - name: horizon
      image: horizon
      probes:
        readiness:
          type: "httpGet"
          port: {{ horizon.port.cont }}
          path: "/"
          # {% if horizon.tls.enabled %}
          scheme: "https"
          # {% endif %}
      volumes:
        - name: horizon-logs
          path: "/var/log/ccp/horizon"
          type: host
          readOnly: False
      pre:
        - name: chown-logs-dir
          command: "sudo /bin/chown horizon:horizon /var/log/ccp/horizon"
      daemon:
        dependencies:
          - keystone
          - memcached
        files:
          - horizon-local-settings
          - openstack-dashboard-conf
          # {% if horizon.tls.enabled %}
          - ca_cert
          # {% endif %}
        command: daemon.sh
    # {% if horizon.tls.enabled %}
    - name: nginx
      image: nginx
      daemon:
        files:
          - servers
          - upstreams
          - server-cert
          - server-key
        command: nginx
    # {% endif %}

files:
  horizon-local-settings:
    path: /etc/openstack-dashboard/local_settings
    content: local_settings.j2
  openstack-dashboard-conf:
    path: /etc/apache2/conf-enabled/openstack-dashboard.conf
    content: openstack-dashboard.conf.j2
  # {% if horizon.tls.enabled %}
  servers:
    path: /etc/nginx/conf.d/servers.conf
    content: servers.conf.j2
    perm: "0400"
  upstreams:
    path: /etc/nginx/conf.d/upstreams.conf
    content: upstreams.conf.j2
    perm: "0400"
  ca_cert:
    path: /opt/ccp/etc/tls/ca.pem
    content: ca-cert.pem.j2
  server-cert:
    path: /opt/ccp/etc/tls/server-cert.pem
    content: server-cert.pem.j2
    perm: "0400"
  server-key:
    path: /opt/ccp/etc/tls/server-key.pem
    content: server-key.pem.j2
    perm: "0400"
  # {% endif %}
